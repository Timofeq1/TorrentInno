# Peer message exchange format

## General notes:

- All messages between peers are translated as raw bytes.

- All indexes are zero based, unless stated otherwise.

- Where applicable, the order of bytes is big-endian.

- Where applicable, the sequence of bytes is translated using hexadecimal encoding. 

## Handshake
```
TorrentInno[peer-id (32 bytes)][info-hash (32 bytes)]
```
*Example*:
```
TorrentInnoba1bd0139c99070e7ed25fd599e603f2b915acf8eb96fca8565a7ed34c4d705441bbcd3f70fbbbac8b5171869c75e274f0b1a6c54f784dc0f763cebb446eee5d
```

**Description**:
The handshake message is sent by one of the peers trying to establish a connection with some other peer. Note that the length of the handshake message is always 75 bytes.

The `info-hash` is the hash of the `torrentinno` file. 

The `peer-id` is a sequence of 32 bytes generated by peer itself. `peer-id` is a unique identifier of a peer and used in all connections.

The peer that receives this message must check if it knows the resource in the `info-hash` field. If it knows this resource, then reply will the same message, substituting `peer-id` with its own id.

If the handshake is successful, then both peers create and maintain a separate connection tied to that specific resource. The connection is biderectional continuous channel where peers exchange length-prefixed messages.

## Peer to peer communication

Each message has the following format: `[body-length (4 bytes)][message-body]`. Where `body-length` is the length of the `[message-body]` (in bytes). Further, only `[message-body]` will be discussed.

Each `[message-body]` has the following format: `[message-type (1 byte)][message-data]`. `[message-type]` is a number (`0x01`, for example)
Currently, only two types of messages are supported:
1) 'Request':  The `[message-data]` has format: `[piece-index (4 bytes)][piece-inner-offset (4 bytes)][block-length (4 bytes)]`. 
This message indicates that the peer wants to fetch the `[block-length]` bytes from the piece with index `[piece-index]`, with inner offset within the piece of length `[piece-inner-offset]` bytes.

2) 'Piece': The `[message-data]` has format: `[piece-index (4 bytes)][piece-inner-offset (4 bytes)][block-length (4 bytes)]data`. The first three fields has the same meaning as in the 'Request' message. The `data` contains the requested part of the file and it must have the length of `block-length` bytes.

*Example:*
The full message to request 1024 bytes with offset 384 bytes offset within the piece 19 looks like this:

- `0x0000000d` - body length (13 bytes)
- `0x01` - message type (Request)
- `0x00000013` - piece index (19)
- `0x00000180` - the piece inner offset (384)
- `0x00000400` - the block length (1024)

References:
[https://www.bittorrent.org/beps/bep_0003.html](https://www.bittorrent.org/beps/bep_0003.html)
